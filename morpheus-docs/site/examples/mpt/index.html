<!--
  ~ Copyright (C) 2014-2018 D3X Systems - All Rights Reserved
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="author" content="Xavier Witdouck">

        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Modern Portfolio Theory - Morpheus</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../.././css/morpheus.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Morpheus</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Overview</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Array <b class="caret"></b></a>
                        <ul class="dropdown-menu">

<li >
    <a href="../../array/overview/">Overview</a>
</li>

<li >
    <a href="../../array/performance/">Performance</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">DataFrame <b class="caret"></b></a>
                        <ul class="dropdown-menu">

<li >
    <a href="../../frame/construction/">Construction</a>
</li>

<li >
    <a href="../../frame/access/">Accessing</a>
</li>

<li >
    <a href="../../frame/reshaping/">Reshaping</a>
</li>

<li >
    <a href="../../frame/filtering/">Filtering</a>
</li>

<li >
    <a href="../../frame/sorting/">Sorting</a>
</li>

<li >
    <a href="../../frame/grouping/">Grouping</a>
</li>

<li >
    <a href="../../frame/finding/">Finding</a>
</li>

<li >
    <a href="../../frame/writing/">Writing</a>
</li>

<li >
    <a href="../../frame/performance/">Performance</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Analysis <b class="caret"></b></a>
                        <ul class="dropdown-menu">

<li >
    <a href="../../analysis/statistics/">Descriptive Statistics</a>
</li>

  <li class="dropdown-submenu">
    <a href="#">Linear Regression</a>
    <ul class="dropdown-menu">

<li >
    <a href="../../regression/ols/">Ordinary Least Squares</a>
</li>

<li >
    <a href="../../regression/wls/">Weighted Least Squares</a>
</li>

<li >
    <a href="../../regression/gls/">Generalized Least Squares</a>
</li>
    </ul>
  </li>

<li >
    <a href="../../analysis/pca/">Principal Component Analysis</a>
</li>

<li >
    <a href="../../analysis/linearalgebra/">Linear Algebra</a>
</li>

<li >
    <a href="../../analysis/timeseries/">Time Series Analysis</a>
</li>

  <li class="dropdown-submenu">
    <a href="#">Examples</a>
    <ul class="dropdown-menu">

<li class="active">
    <a href="./">Modern Portfolio Theory</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Visualization <b class="caret"></b></a>
                        <ul class="dropdown-menu">

  <li class="dropdown-submenu">
    <a href="#">Charts</a>
    <ul class="dropdown-menu">

<li >
    <a href="../../viz/charts/overview/">Overview</a>
</li>

<li >
    <a href="../../viz/charts/embed/">Embedding (HTML)</a>
</li>

<li >
    <a href="../../viz/charts/gallery1/">Gallery (Google)</a>
</li>

<li >
    <a href="../../viz/charts/gallery2/">Gallery (JFree)</a>
</li>
    </ul>
  </li>

<li >
    <a href="../../viz/tables/overview/">Tables</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data Sources <b class="caret"></b></a>
                        <ul class="dropdown-menu">

<li >
    <a href="../../providers/quandl/">Quandl</a>
</li>

<li >
    <a href="../../providers/fred/">Federal Reserve</a>
</li>

<li >
    <a href="../../providers/google/">Google Finance</a>
</li>

<li >
    <a href="../../providers/yahoo/">Yahoo Finance</a>
</li>

<li >
    <a href="../../providers/world-bank/">World Bank</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../../analysis/timeseries/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../viz/charts/overview/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/zavtech/morpheus-core">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#modern-portfolio-theory">Modern Portfolio Theory</a></li>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#risk-return">Risk &amp; Return</a></li>
            <li><a href="#portfolio-return">Portfolio Return</a></li>
            <li><a href="#portfolio-risk">Portfolio Risk</a></li>
            <li><a href="#sharpe-ratio">Sharpe Ratio</a></li>
            <li><a href="#examples">Examples</a></li>
            <li><a href="#two-assets">Two Assets</a></li>
            <li><a href="#asset-selection">Asset Selection</a></li>
            <li><a href="#multiple-assets">Multiple Assets</a></li>
            <li><a href="#robo-advisor">Robo-Advisor</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="modern-portfolio-theory">Modern Portfolio Theory</h2>
<h3 id="introduction">Introduction</h3>
<p>In 1952, <a href="https://en.wikipedia.org/wiki/Harry_Markowitz">Harry Markowitz</a> published a seminal paper in the Journal of Finance
titled <strong>Portfolio Selection</strong>, where he first introduced <a href="https://en.wikipedia.org/wiki/Modern_portfolio_theory">Modern Portfolio Theory</a>
(MPT), which quantifies the <strong>risk</strong> and <strong>return</strong> trade-off when constructing portfolios of risky assets. The theory formalizes
the concept of <strong>diversification</strong> in mathematical terms, and suggests that rational investors seek to make investment decisions
that <strong>maximize portfolio return</strong> for a given level of <strong>risk</strong>. It frames the investment problem not only as an asset selection
challenge, but also of <strong>sizing the positions</strong> of each chosen risky asset in the portfolio. MPT also introduces the concept of
<a href="https://en.wikipedia.org/wiki/Systematic_risk">systematic</a> versus <a href="http://www.investopedia.com/terms/u/unsystematicrisk.asp">non-systematic</a>
risk, the latter of which can be diversified away in a well proportioned portfolio. Systematic risk refers to general market
wide risks such as interest rate risk, business recessions or wars, while non-systematic risk (also known as specific risk)
relates to the <strong>idiosyncratic risks</strong> associated with an individual security.</p>
<p>Modern Portfolio Theory is still in widespread use today in professional investment management circles, and remains one of
the foundational frameworks used to build efficient risk adjusted portfolios. Markowitz was awarded the <strong>Nobel Memorial
Prize in Economic Sciences</strong> in 1990 for his work on MPT.</p>
<h3 id="risk-return">Risk &amp; Return</h3>
<p>Before we look at an example, we first need to discuss the concepts of <strong>risk</strong> and <strong>return</strong> in the context of a portfolio
of risky assets. It seems eminently reasonable to expect that a rational investor makes decisions so as to <strong>maximize investment
return</strong> while <strong>minimizing the risk</strong> or uncertainty of that return. While return is an unambiguous concept, risk or uncertainty
is not necessarily so easily quantified. In the context of MPT however, risk is defined as the <strong>variance of the portfolio returns</strong>,
which is a function of the <strong>variance and covarinace</strong> of the individual asset returns in the portfolio. More on this <a href="#portfolio-risk">later</a>,
but first let us discuss portfolio return.</p>
<h3 id="portfolio-return">Portfolio Return</h3>
<p>Consider investment returns generated by a portfolio of risky assets. <strong>Portfolio return</strong> is simply the weighted sum of the
returns on the individual assets in the portfolio, which can be expressed as per the equation below, where \(w_{i}\)
represents the <strong>weight</strong> (percentage of capital) of asset i, \(r_{i}\) the return on asset i, and \(R_{p}\) the overall
portfolio return.</p>
<p>$$ R_{p} = \sum_{i=1}^{n} w_{i} * r_{i} $$</p>
<p>In order to illustrate the validity of this expression, consider a two asset hypothetical portfolio. Let us assume we have $1000
of capital, and we have decided to invest in just two stocks (n=2), namely Amazon and Apple. For lack of a strong opinion, we
simply split our investment 50/50 between the two names, and then over a year we see Apple return 15% and Amazon returns 8%.
How much does our portfolio return? </p>
<p>Ignoring the above formula for the moment, we can easily calculate the profit from each $500 dollar investment, sum these profits
and then calculate the resulting return on our $1000 initial investment, which comes out to be 11.5%.  In general terms, the
<strong>future value</strong> <code>F</code> of some monetary amount can be related to its <strong>present value</strong> <code>P</code> and a <strong>rate of return</strong> <code>R</code> as follows:</p>
<p>$$ F = P (1 + R) $$</p>
<p>Since we are ultimately trying to calculate the portfolio return, we need to write this expression in terms of the <strong>present
value and the return on the individual assets</strong> in the portfolio. The expression below does just this, where \(p_{i}\) and
\(r_{i}\) represent the present value and return of individual assets respectively, and subscript <code>p</code> denotes the portfolio
value: </p>
<p>$$ F_{p} = \sum_{i=1}^{n} p_{i} (1 + r_{i}) \ where \ P_{p} = \sum_{i=1}^{n} p_{i} $$</p>
<p>Considering our <strong>two asset example</strong>, we can expand the equation to yield:</p>
<p>$$ \begin{align}
F_{p} &amp;= p_{1} (1 + r_{1}) + p_{2} ( 1 + r_{2}) \\
F_{p} &amp;= p_{1} + p_{2} + p_{1} r_{1} + p_{2} r_{2} \\
F_{p} &amp;= P_{p} + p_{1} r_{1} + p_{2} r_{2} \\
\end{align} $$</p>
<p>We know that from our original future value equation we can express the return of the portfolio as:</p>
<p>$$ R_{p} = \frac{F_{p}}{P_{p}} - 1 $$</p>
<p>Therefore if we divide the prior equation for our two asset scenario by the present value of the portfolio we get an expression
for the portfolio return in terms of the individual asset returns, which is essentially the same as the weighted sum of the asset
returns as defined earlier.</p>
<p>$$ R_{p} = \frac{F_{p}}{P_{p}} - 1 = \frac{p_{1} r_{1} + p_{2} r_{2}}{P_{p}} = w_{1} r_{1} + w_{2} r_{2} $$</p>
<h3 id="portfolio-risk">Portfolio Risk</h3>
<p>While <strong>portfolio return</strong> is <strong>conceptually unambiguous</strong>, defining portfolio risk is less clear cut. In the case of Modern
Portfolio Theory, risk is defined as the <strong>variance or volatility of the returns</strong>, which is certainly consistent with intuition,
since high variance implies a high degree of uncertainty. Portfolio returns that are extremely volatile are not only emotionally
hard to stomach, but may force an investor to crystallize losses at a very inopportune time due to a requirement to gain access
to capital. Long term investors often think of risk in different terms, and in fact <a href="https://en.wikipedia.org/wiki/Warren_Buffett">Warren Buffet</a>,
who is arguably the greatest investor of all time, would probably not consider volatility as an appropriate metric. Instead,
he would be more likely to think in terms of the potential for <strong>permanent loss of capital</strong>.</p>
<p>Few of us have the investment acumen or long horizon of Warren Buffet, so for mere mortals, let us stick with return volatility
as our best measure of portfolio risk. While individual asset return volatility is simple to compute, calculating portfolio
level risk is less trivial as it involves understanding the <strong>interaction of individual asset returns</strong>. That is to say, no
two assets in a portfolio are likely to be 100% correlated, and therefore combining uncorrelated assets is bound to affect
risk in ways that need to be quantified. Let us begin with our definition of portfolio return variance which using the
<a href="https://en.wikipedia.org/wiki/Expected_value">expectation operator</a> is just the usual expression for <a href="https://en.wikipedia.org/wiki/Variance">variance</a>. </p>
<p>$$ \sigma^2 = E[ ( R_{p} - \bar{R}_{p} )^2 ] $$</p>
<p>In this equation \(r_{p}\) represents the return generated by an instance of the portfolio while \(\bar{r}_{p}\) represents
the <strong>average expected return</strong> from this portfolio. To illustrate, consider a two asset portfolio where we expand the above
expression to be in terms of the individual assets that make up the portfolio.</p>
<p>$$ \begin{align}
\sigma^2 &amp;= E[ ( R_{p} - \bar{R_{p}})^2 ] \\
\sigma^2 &amp;= E[ ( w_{1} r_{1} + w_{2} r_{2} - (w_{1} \bar{r_{1}} + w_{2}\bar{r_{2}}) )^2 ] \\
\sigma^2 &amp;= E[ ( w_{1} ( r_{1} - \bar{r_{1}} ) + w_{2} ( r_{2} - \bar{r_{2}}))^2 ] \\
\sigma^2 &amp;= E[ w_{1}^2 ( r_{1} - \bar{r_{1}} )^2 + w_{2}^2 ( r_{2} - \bar{r_{2}})^2 + 2 w_{1} w_{2} E[(r_{1} - \bar{r_{1}})(r_{2} - \bar{r_{2}})]] \\
\end{align} $$</p>
<p>Since the <strong>asset weights are not stochastic in nature</strong>, we can take them outside of the expectation operator to yield the following:</p>
<p>$$ \sigma^2 = w_{1}^2 E[( r_{1} - \bar{r_{1}})^2] + w_{2}^2 E[( r_{2} - \bar{r_{2}})^2] + 2 w_{1} w_{2} E[(r_{1} - \bar{r_{1}})(r_{2} - \bar{r_{2}})]] $$</p>
<p>It now becomes clear that the portfolio variance is a function of the <strong>individual asset variances</strong> as well as their
<strong>covariance</strong>, so we can write the same expression in a more concise manner as shown below. Notice that this expression
suggests that if we combine risky assets in a portfolio that have a <strong>negative covariance</strong>, the overall portfolio <strong>risk will
be reduced</strong>. This is essentially diversification quantified, and it is a central principle of MPT.</p>
<p>$$ \sigma^2 = w_{1}^2 \sigma_{1}^2 + w_{2}^2 \sigma_{2}^2 + 2 w_{1} w_{2} \sigma_{12}  $$</p>
<p>While the above derivation is for a 2 asset portfolio, this expression can be generalized to an N asset portfolio and
written in <strong>matrix form</strong> as below. The <code>w</code> term represents an <code>nx1</code> vector of asset weights, and capital sigma represents
the <code>nxn</code> covariance matrix of asset returns, the diagonal elements of which are the individual asset return variances.</p>
<p>$$ \sigma^2 = w^T \Sigma w $$</p>
<h3 id="sharpe-ratio">Sharpe Ratio</h3>
<p>The <a href="https://en.wikipedia.org/wiki/Sharpe_ratio">Sharpe Ratio</a> is a widely used performance metric in finance and is named
after Nobel Laureate <a href="https://en.wikipedia.org/wiki/William_F._Sharpe">William F. Sharpe</a> who first developed it. The ratio
is basically the average return earned in <strong>excess</strong> of the <strong>risk free rate</strong> per unit of volatility, and is therefore a
standardized way of expressing <strong>risk adjusted return</strong>. Mathematically, it is defined as follows (where \(R_{p}\)
represents portfolio return, \(\bar{R_{f}}\) is the risk free return and \(\sigma_{p}\) is portfolio risk):</p>
<p>$$ S_{p} = \frac{E[ R_{p} - \bar{R_{f}}]}{\sigma_{p}}  $$</p>
<p>A Sharpe Ratio can be computed <em>ex-ante</em> based on <strong>forecasts</strong> of expected risk and return, or otherwise as an <em>ex-post</em>
measure based on realized returns. Given that the return measure (the stuff we like) is in the numerator and the risk measure
(the stuff we don't like) is in the denominator, the higher the Sharpe Ratio the better.</p>
<p>While it is very widely used, the Sharpe Ratio is not without its detractors. One of the often quoted grievances with the
measure is that it treats <strong>upside volatility</strong> equally with <strong>downside volatility</strong>. This may be reasonable in a long / short
portfolio, but perhaps less so in a long-only portfolio (i.e. no shorting constraint). In order to address this, a
variation of the Sharpe Ratio exists called the <a href="https://en.wikipedia.org/wiki/Sortino_ratio">Sortino Ratio</a> which
only includes returns below a certain threshold when computing volatility. </p>
<p>Another potential concern is that the Sharpe Ratio does not distinguish between <strong>systematic</strong> and <strong>non-systematic</strong> risk,
the latter of which can be diversified away in a well balanced portfolio. The <a href="https://en.wikipedia.org/wiki/Treynor_ratio">Treynor Ratio</a>
attempts to address this by estimating the systematic risk only, and using that as the denominator in the above expression.</p>
<p>Finally, one of the trickiest issues with the Sharpe Ratio is scaling it to different time horizons. For example, how
do you compute an annualized Sharpe from daily returns? Most techniques scale risk and return on the assumption that
returns are <strong>normally distributed</strong>, however it is well known that asset returns are not normal and exhibit excess
<strong>kurtosis</strong> and often <strong>skewness</strong>. For more details on some of the challenges in computing Sharpe Ratios, I high recommend a
paper by Andrew W. Lo titled <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.460.3450&amp;rep=rep1&amp;type=pdf">The Statistics of Sharpe Ratios</a>.</p>
<h3 id="examples">Examples</h3>
<p>Now that we know how to calculate <strong>portfolio return and risk</strong>, let us look at how we can apply this knowledge, and
more importantly, demonstrate how we can use Modern Portfolio Theory to construct an efficient investment portfolio of
risky assets.  The examples in the following sections leverage the Morpheus data source adapter for <a href="../../providers/yahoo/">Yahoo Finance</a>,
more details of which can be found <a href="../../../providers/yahoo">here</a>. The library is available on <strong>Maven Central</strong> and can
therefore be added to your build tool of choice:</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.zavtech&lt;/groupId&gt;
    &lt;artifactId&gt;morpheus-yahoo&lt;/artifactId&gt;
    &lt;version&gt;${VERSION}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h3 id="two-assets">Two Assets</h3>
<p>Consider a <strong>two asset</strong> portfolio where we have already convinced ourselves that we want to buy Apple and Amazon, but we are not sure how much of our capital to invest in each. We obviously do not know what the future may bring,
but let us look back over the past year to see what happened on the assumption that it may help influence our decision.
The plot below shows the cumulative returns of both securities over the past year, which clearly demonstrates what a great
run they have had. With the benefit of hindsight of course, you would have invested all your capital in Apple as it
outperformed Amazon by some margin. Looking forward however, the performance of these stocks could be reversed, so we
should probably spread our bets across the two.</p>
<p align="center">
    <img class="chart" src="../../images/mpt/mpt_0.png"/>
</p>

<p>The code to generate this plot is as follows:</p>
<?prettify?>

<pre><code class="java">LocalDate end = LocalDate.now();
LocalDate start = end.minusYears(1);
Array&lt;String&gt; tickers = Array.of(&quot;AAPL&quot;, &quot;AMZN&quot;);

YahooFinance yahoo = new YahooFinance();
DataFrame&lt;LocalDate,String&gt; cumReturns = yahoo.getCumReturns(start, end, tickers);
cumReturns.applyDoubles(v -&gt; v.getDouble() * 100d);

Chart.create().withLinePlot(cumReturns, chart -&gt; {
    chart.title().withText(&quot;Cumulative Asset Returns&quot;);
    chart.subtitle().withText(&quot;Range: (&quot; + start + &quot; to&quot; + end + &quot;)&quot;);
    chart.plot().axes().domain().label().withText(&quot;Date&quot;);
    chart.plot().axes().range(0).label().withText(&quot;Return&quot;);
    chart.plot().axes().range(0).format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.show();
});
</code></pre>

<p>To get a sense of the risk / return characteristics of our two asset portfolio, we are going to <strong>generate 10,000 random
portfolios</strong> where we invest different amounts in Apple and Amazon ranging from 0% to 100% of our capital in one asset and
the remainder in the other asset. The function below returns a <code>DataFrame</code> of random portfolio weights in N assets that
sum to 1 in all cases, and therefore each portfolio represents a <strong>fully invested</strong> scenario.</p>
<?prettify?>

<pre><code class="java">/**
 * A function that generates N long only random portfolios with weights that sum to 1
 * @param count     the number of portfolios / rows in the DataFrame
 * @param tickers   the security tickers to include
 * @return          the frame of N random portfolios, 1 per row
 */
DataFrame&lt;Integer,String&gt; randomPortfolios(int count, Iterable&lt;String&gt; tickers) {
    DataFrame&lt;Integer,String&gt; weights = DataFrame.ofDoubles(Range.of(0, count), tickers);
    weights.applyDoubles(v -&gt; Math.random());
    weights.rows().forEach(row -&gt; {
        final double sum = row.stats().sum();
        row.applyDoubles(v -&gt; {
            double weight = v.getDouble();
            return weight / sum;
        });
    });
    return weights;
}
</code></pre>

<p>In order to calculate the risk and return characteristics of these 10,000 portfolios, we first need to compute the
<strong>covariance matrix of the returns</strong> between Apple and Amazon, and then also compute the <strong>cumulative asset returns</strong>
over the historical horizon in question. With these quantities, it is fairly simple to compute the risk &amp; return of
each portfolio, which can then be plotted on a scatter chart to see how they compare. The resulting plot is shown
below, and is followed by the code to generate it. Note that since we are using daily returns to compute the covariance
matrix, we need to <strong>annualize</strong> it, which we do by multiplying by 252 (on the assumption there are 252 trading days
in the year). Since the cumulative returns are based on a 1-year look back window, there is no need to annualize the
returns.</p>
<p align="center">
    <img class="chart" src="../../images/mpt/mpt_1.png"/>
</p>

<?prettify?>

<pre><code class="java">//Define portfolio count, investment horizon and universe
int count = 10000;
LocalDate end = LocalDate.now();
LocalDate start = end.minusYears(1);
Array&lt;String&gt; tickers = Array.of(&quot;AAPL&quot;, &quot;AMZN&quot;);

//Grab daily returns and cumulative returns from Yahoo Finance
YahooFinance yahoo = new YahooFinance();
DataFrame&lt;LocalDate,String&gt; dayReturns = yahoo.getDailyReturns(start, end, tickers);
DataFrame&lt;LocalDate,String&gt; cumReturns = yahoo.getCumReturns(start, end, tickers);

//Compute asset covariance matrix from daily returns and annualize
DataFrame&lt;String,String&gt; sigma = dayReturns.cols().stats().covariance().applyDoubles(v -&gt; v.getDouble() * 252);
DataFrame&lt;LocalDate,String&gt; assetReturns = cumReturns.rows().last().map(DataFrameRow::toDataFrame).get();

//Generate random portfolios and compute risk &amp; return for each
DataFrame&lt;Integer,String&gt; portfolios = randomPortfolios(count, tickers);
DataFrame&lt;Integer,String&gt;  results = DataFrame.ofDoubles(Range.of(0, count), Array.of(&quot;Risk&quot;, &quot;Return&quot;));
portfolios.rows().forEach(row -&gt; {
    DataFrame&lt;Integer,String&gt; weights = row.toDataFrame();
    double portReturn = weights.dot(assetReturns.transpose()).data().getDouble(0, 0);
    double portVariance = weights.dot(sigma).dot(weights.transpose()).data().getDouble(0, 0);
    results.data().setDouble(row.key(), &quot;Return&quot;, portReturn * 100d);
    results.data().setDouble(row.key(), &quot;Risk&quot;, Math.sqrt(portVariance) * 100d);
});

//Plot the results using a scatter plot
Chart.create().withScatterPlot(results, false, &quot;Risk&quot;, chart -&gt; {
    chart.title().withText(&quot;Risk / Return Profiles For AAPL+AMZN Portfolios&quot;);
    chart.subtitle().withText(count + &quot; Portfolio Combinations Simulated&quot;);
    chart.plot().axes().domain().label().withText(&quot;Portfolio Risk&quot;);
    chart.plot().axes().domain().format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.plot().axes().range(0).label().withText(&quot;Portfolio Return&quot;);
    chart.plot().axes().range(0).format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.show();
});
</code></pre>

<p>There are a few notable observations about the plot as follows:</p>
<ul>
<li>It appears to be impossible to create a portfolio with a risk lower than about 15.7% volatility.</li>
<li>If you were willing to accept 16% risk, there are two portfolios, one of which has a much better return than the other.</li>
<li>Much beyond 17% risk, it appears returns suffer tremendously due to overweight in one of the assets.</li>
<li>The best possible return appears to be about 37% at a risk level just north of 17%.</li>
</ul>
<p>A rational investor clearly wants to be on the upper part of this curve for a <strong>given level of risk</strong>. For example,
at 17% volatility, you could either have achieved 23.5% return with a portfolio on the lower segment of the curve
or close to 37% on the upper part. Which one do you prefer? The upper part of the curve is referred to as the
<a href="https://en.wikipedia.org/wiki/Efficient_frontier">Efficient Frontier</a>, and moreover, there exists a special case
on this curve often referred to as the <strong>Markowitz Portfolio</strong>, which has the highest risk adjusted return of all
the candidate portfolios. It is essentially the <strong>mean-variance optimal portfolio</strong> and can be calculated by
maximizing the utility defined by the objective function below, subject to whatever constraints you may impose
(in this case we assume <strong>long only</strong> and <strong>fully invested</strong>):</p>
<p>$$ U_{p} = w^T r - w^T \Sigma w $$</p>
<p>The \(w\) and \(r\) terms represent <code>nx1</code> vectors of asset <strong>weights</strong> and <strong>returns</strong> respectively, while capital
<strong>sigma</strong> represents the <code>nxn</code> asset covariance matrix. This objective function is essentially saying we like return
and do not like risk, and our goal is to select an <code>nx1</code> vector of asset weights that maximizes this expression given
asset returns and a covariance matrix. In this example, we are looking back at a historical scenario so we can calculate
returns and the covariance based on realized market prices. In reality, we need to make <strong>judgements about the future</strong>,
and therefore are required to <strong>estimate future returns and covariance</strong>, which is where things can get tricky. Calculating
the <strong>Markowitz Portfolio</strong> given constraints (as in this case where we impose a long only fully invested constraint such
that the elements of W are all positive and sum to 1) is a <a href="https://en.wikipedia.org/wiki/Quadratic_programming">quadratic optimization</a>
problem that requires appropriate software and is beyond the scope of this article. A good commercial package
to consider is <a href="http://docs.mosek.com/8.0/javafusion/case-studies-portfolio.html">MOSEK</a>, or for an Open Source
solution you may consider <a href="https://www.optaplanner.org/">OptaPlanner</a>.</p>
<h3 id="asset-selection">Asset Selection</h3>
<p>Modern Portfolio Theory is fundamentally about <strong>sizing positions</strong> of risky assets in a portfolio, it is not
about asset selection. Having said that, it can be useful to compare the risk / return profiles of portfolios
constructed from different risky assets. In the prior example we had already decided that we wanted to invest
in Apple and Amazon, but were there better two asset portfolio combinations we should have considered? The plot
below, followed by the code that generated it, is essentially an extension of the prior example where in this
case we generate multiple 10,000 portfolio combinations with different asset constituents to see how they compare.</p>
<p align="center">
    <img class="chart" src="../../images/mpt/mpt_2.png"/>
</p>

<p>It is clear from the chart that the 5 two asset portfolios in this example have very different risk / return
profiles, with the Apple / Amazom combination being the most risky, but certainly having some of the highest
returns. With that being said, if your investment objective was to achieve around a 12.0% return (very
aspirational in today's world of zero interest rates), your best bet would be to choose the VTI / BND combination
as it appears to have the <strong>potentia</strong>l to generate this return for less than 5% risk. Compare this to some of the other
portfolio combinations for which you need to accept a much <strong>higher level of risk</strong> to achieve the <strong>same return</strong>.</p>
<?prettify?>

<pre><code class="java">//Define portfolio count, investment horizon
int count = 10000;
LocalDate end = LocalDate.now();
LocalDate start = end.minusYears(1);
YahooFinance yahoo = new YahooFinance();

Array&lt;DataFrame&lt;Integer,String&gt;&gt; results = Array.of(
    Array.of(&quot;VTI&quot;, &quot;BND&quot;),
    Array.of(&quot;AAPL&quot;, &quot;AMZN&quot;),
    Array.of(&quot;GOOGL&quot;, &quot;BND&quot;),
    Array.of(&quot;ORCL&quot;, &quot;KO&quot;),
    Array.of(&quot;VWO&quot;, &quot;VNQ&quot;)
).map(v -&gt; {
    //Access tickers
    Array&lt;String&gt; tickers = v.getValue();
    //Grab daily returns and cumulative returns from Yahoo Finance
    DataFrame&lt;LocalDate,String&gt; dayReturns = yahoo.getDailyReturns(start, end, tickers);
    DataFrame&lt;LocalDate,String&gt; cumReturns = yahoo.getCumReturns(start, end, tickers);
    //Compute asset covariance matrix from daily returns and annualize
    DataFrame&lt;String,String&gt; sigma = dayReturns.cols().stats().covariance().applyDoubles(x -&gt; x.getDouble() * 252);
    DataFrame&lt;LocalDate,String&gt; assetReturns = cumReturns.rows().last().map(DataFrameRow::toDataFrame).get();
    //Generate random portfolios and compute risk &amp; return for each
    String label = String.format(&quot;%s+%s&quot;, tickers.getValue(0), tickers.getValue(1));
    DataFrame&lt;Integer,String&gt; portfolios = randomPortfolios(count, tickers);
    DataFrame&lt;Integer,String&gt;  riskReturn = DataFrame.ofDoubles(Range.of(0, count), Array.of(&quot;Risk&quot;, label));
    portfolios.rows().forEach(row -&gt; {
        DataFrame&lt;Integer,String&gt; weights = row.toDataFrame();
        double portReturn = weights.dot(assetReturns.transpose()).data().getDouble(0, 0);
        double portVariance = weights.dot(sigma).dot(weights.transpose()).data().getDouble(0, 0);
        riskReturn.data().setDouble(row.key(), label, portReturn * 100d);
        riskReturn.data().setDouble(row.key(), &quot;Risk&quot;, Math.sqrt(portVariance) * 100d);
    });
    return riskReturn;
});

DataFrame&lt;Integer,String&gt; first = results.getValue(0);
Chart.create().&lt;Integer,String&gt;withScatterPlot(first, false, &quot;Risk&quot;, chart -&gt; {
    for (int i=1; i&lt;results.length(); ++i) {
        chart.plot().&lt;String&gt;data().add(results.getValue(i), &quot;Risk&quot;);
        chart.plot().render(i).withDots();
    }
    chart.plot().axes().domain().label().withText(&quot;Portfolio Risk&quot;);
    chart.plot().axes().domain().format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.plot().axes().range(0).label().withText(&quot;Portfolio Return&quot;);
    chart.plot().axes().range(0).format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.title().withText(&quot;Risk / Return Profiles of Various Two Asset Portfolios&quot;);
    chart.subtitle().withText(count + &quot; Portfolio Combinations Simulated&quot;);
    chart.legend().on().right();
    chart.show();
});
</code></pre>

<h3 id="multiple-assets">Multiple Assets</h3>
<p>So far we have limited our example portfolios to two assets in order to help develop the intuition behind Modern
Portfolio Theory. In reality however, real world portfolios are likely to include more assets, although exactly
how many are required to achieve a reasonable level of diversification is open to debate. Consider an investable
universe of 6 securities represented by broad based low cost ETFs that serve as reasonable proxies for major asset
classes. The table below summarizes these candidates.</p>
<table>
<thead>
<tr>
<th>Ticker</th>
<th>Name</th>
<th>Provider</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>VWO</td>
<td>Vanguard FTSE Emerging Markets ETF</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/VWO/profile?p=VWO">Details</a></td>
</tr>
<tr>
<td>VNQ</td>
<td>Vanguard REIT ETF</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/VNQ/profile?p=VNQ">Details</a></td>
</tr>
<tr>
<td>VEA</td>
<td>Vanguard FTSE Developed Markets ETF</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/VEA/profile?p=VEA">Details</a></td>
</tr>
<tr>
<td>DBC</td>
<td>PowerShares DB Commodity Tracking ETF</td>
<td>Powershares</td>
<td><a href="https://finance.yahoo.com/quote/DBC/profile?p=DBC">Details</a></td>
</tr>
<tr>
<td>VTI</td>
<td>Vanguard Total Stock Market ETF</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/DBC/profile?p=VTI">Details</a></td>
</tr>
<tr>
<td>BND</td>
<td>Vanguard Total Bond Market ETF</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/BND/profile?p=BND">Details</a></td>
</tr>
</tbody>
</table>
<p>To get a sense of how the risk / return profiles of portfolios evolve as we include more assets, we can generate 10,000
random portfolios first with 2 assets, then 3 and all the way to 6. In the case of two assets, we expect to see our
rotated parabola, but what happens when you have more degrees of freedom in the portfolio? The plot below is the answer.
As we go beyond two assets, the scatter becomes more pronounced, and while risk is generally reduced due to the fact that
the assets are not perfectly correlated, return also suffers somewhat. Having said that, the <strong>Efficient Frontiers</strong> of
the more diversified portfolios appear to provide a better risk / return trade off than the two asset portfolio.  </p>
<p align="center">
    <img class="chart" src="../../images/mpt/mpt_3.png"/>
</p>

<p>The code to generate the above plot of 5 lots of 10,000 portfolios with various assets is as follows: </p>
<?prettify?>

<pre><code class="java">//Define portfolio count, investment horizon
int count = 10000;
LocalDate end = LocalDate.now();
LocalDate start = end.minusYears(1);
YahooFinance yahoo = new YahooFinance();

Array&lt;DataFrame&lt;Integer,String&gt;&gt; results = Array.of(
    Array.of(&quot;VWO&quot;, &quot;VNQ&quot;),
    Array.of(&quot;VWO&quot;, &quot;VNQ&quot;, &quot;VEA&quot;),
    Array.of(&quot;VWO&quot;, &quot;VNQ&quot;, &quot;VEA&quot;, &quot;DBC&quot;),
    Array.of(&quot;VWO&quot;, &quot;VNQ&quot;, &quot;VEA&quot;, &quot;DBC&quot;, &quot;VTI&quot;),
    Array.of(&quot;VWO&quot;, &quot;VNQ&quot;, &quot;VEA&quot;, &quot;DBC&quot;, &quot;VTI&quot;, &quot;BND&quot;)
).map(v -&gt; {
    //Access tickers
    Array&lt;String&gt; tickers = v.getValue();
    //Grab daily returns and cumulative returns from Yahoo Finance
    DataFrame&lt;LocalDate,String&gt; dayReturns = yahoo.getDailyReturns(start, end, tickers);
    DataFrame&lt;LocalDate,String&gt; cumReturns = yahoo.getCumReturns(start, end, tickers);
    //Compute asset covariance matrix from daily returns and annualize
    DataFrame&lt;String,String&gt; sigma = dayReturns.cols().stats().covariance().applyDoubles(x -&gt; x.getDouble() * 252);
    DataFrame&lt;LocalDate,String&gt; assetReturns = cumReturns.rows().last().map(DataFrameRow::toDataFrame).get();
    //Generate random portfolios and compute risk &amp; return for each
    String label = String.format(&quot;%s Assets&quot;, tickers.length());
    DataFrame&lt;Integer,String&gt; portfolios = randomPortfolios(count, tickers);
    DataFrame&lt;Integer,String&gt;  riskReturn = DataFrame.ofDoubles(Range.of(0, count), Array.of(&quot;Risk&quot;, label));
    portfolios.rows().forEach(row -&gt; {
        DataFrame&lt;Integer,String&gt; weights = row.toDataFrame();
        double portReturn = weights.dot(assetReturns.transpose()).data().getDouble(0, 0);
        double portVariance = weights.dot(sigma).dot(weights.transpose()).data().getDouble(0, 0);
        riskReturn.data().setDouble(row.key(), 1, portReturn * 100d);
        riskReturn.data().setDouble(row.key(), 0, Math.sqrt(portVariance) * 100d);
    });
    return riskReturn;
});

DataFrame&lt;Integer,String&gt; first = results.getValue(0);
Chart.create().&lt;Integer,String&gt;withScatterPlot(first, false, &quot;Risk&quot;, chart -&gt; {
    for (int i=1; i&lt;results.length(); ++i) {
        chart.plot().&lt;String&gt;data().add(results.getValue(i), &quot;Risk&quot;);
        chart.plot().render(i).withDots();
    }
    chart.plot().axes().domain().label().withText(&quot;Portfolio Risk&quot;);
    chart.plot().axes().domain().format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.plot().axes().range(0).label().withText(&quot;Portfolio Return&quot;);
    chart.plot().axes().range(0).format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.title().withText(&quot;Risk / Return Profiles of Portfolios With Increasing Assets&quot;);
    chart.subtitle().withText(count + &quot; Portfolio Combinations Simulated&quot;);
    chart.legend().on().bottom();
    chart.show();
});
</code></pre>

<h3 id="robo-advisor">Robo-Advisor</h3>
<p>A fairly recent innovation in the investment management space relates to what are called <a href="https://en.wikipedia.org/wiki/Robo-advisor">Robo-Advisors</a>,
which are essentially online investment solutions aimed mostly at retail investors. They are called Robo-Advisors
because they automate the construction of portfolios using software based on an investor's risk appetite and their
investment objective, which they assess by posing a number of questions via their website. There are already many
players in this space, and most of them construct well-balanced portfolios consisting of 5-7 assets, all of which
are <strong>broad based and low cost</strong> <a href="https://en.wikipedia.org/wiki/Exchange-traded_fund">Exchange Traded Funds</a>.</p>
<p>To avoid any suggestion that I am endorsing or recommending these services, I am consciously avoiding naming names, but
I visited the website of one of the larger advisors and proceeded to complete the questionnaire after which it proposed
the portfolio in the table below. The purpose of this discussion is not to make any judgement on how good this portfolio
is versus other potential investments, but really to get a sense of how efficient the proposed portfolio is from a
risk / return  stand point.</p>
<table>
<thead>
<tr>
<th>Ticker</th>
<th>Name</th>
<th>Weight</th>
<th>Provider</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>VTI</td>
<td>Vanguard Total Stock Market ETF</td>
<td>35%</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/DBC/profile?p=VTI">Details</a></td>
</tr>
<tr>
<td>VEA</td>
<td>Vanguard FTSE Developed Markets ETF</td>
<td>21%</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/VEA/profile?p=VEA">Details</a></td>
</tr>
<tr>
<td>VWO</td>
<td>Vanguard FTSE Emerging Markets ETF</td>
<td>16%</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/VWO/profile?p=VWO">Details</a></td>
</tr>
<tr>
<td>VTEB</td>
<td>Vanguard Tax-Exempt Bond ETF</td>
<td>15%</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/VTEB/profile?p=VTEB">Details</a></td>
</tr>
<tr>
<td>VIG</td>
<td>Vanguard Dividend Appreciation ETF</td>
<td>8%</td>
<td>Vanguard</td>
<td><a href="https://finance.yahoo.com/quote/VIG/profile?p=VIG">Details</a></td>
</tr>
<tr>
<td>XLE</td>
<td>Energy Select Sector SPDR ETF</td>
<td>5%</td>
<td>State Street</td>
<td><a href="https://finance.yahoo.com/quote/XLE/profile?p=XLE">Details</a></td>
</tr>
</tbody>
</table>
<h4 id="ramdom-portfolios">Ramdom Portfolios</h4>
<p>Ignoring the proposed weightings for the moment, consider generating 10,000 <strong>long-only fully invested random portfolios</strong>
involving these assets, and then computing the resulting equity curves. This will give us a sense of the various scenarios we can
generate with this asset universe, and in particular allow us to understand the <strong>degree of dispersion</strong> in outcomes. The plot
below illustrates 10,000 equity curves based on the <strong>past 1 year returns</strong>, suggesting a return spread ranging from approximately
2.5% all the way to 18.15%, which is pretty enormous.</p>
<p align="center">
    <img class="chart" src="../../images/mpt/mpt_4.png"/>
</p>

<p>The code to generate the above plot is as follows:</p>
<?prettify?>

<pre><code class="java">int portfolioCount = 10000;
Range&lt;LocalDate&gt; range = Range.of(LocalDate.now().minusYears(1), LocalDate.now());
Array&lt;String&gt; tickers = Array.of(&quot;VTI&quot;, &quot;BND&quot;, &quot;VWO&quot;, &quot;VTEB&quot;, &quot;VIG&quot;, &quot;XLE&quot;);
DataFrame&lt;Integer,String&gt; portfolios = randomPortfolios(portfolioCount, tickers);
DataFrame&lt;LocalDate,String&gt; performance = getEquityCurves(range, portfolios);
Chart.create().withLinePlot(performance.applyDoubles(v -&gt; v.getDouble() * 100d), chart -&gt; {
    chart.title().withText(portfolioCount + &quot; Equity Curves (Past 1 Year Returns)&quot;);
    chart.subtitle().withText(&quot;Robo-Advisor Universe: VTI, BND, VWO, VTEB, VIG, XLE&quot;);
    chart.plot().axes().domain().label().withText(&quot;Date&quot;);
    chart.plot().axes().range(0).label().withText(&quot;Portfolio Return&quot;);
    chart.plot().axes().range(0).format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.show();
});
</code></pre>

<p>The example uses the following function in order to compute the equity curves for the <code>DataFrame</code> of 10,000 random portfolios.
This function expects an <code>mxn</code> frame of portfolio weighting configurations where <code>m</code> is the number of portfolios and <code>n</code> the number
of assets. The resulting <code>DataFrame</code> has <code>txm</code> dimensions where <code>t</code> is the number of dates, and the <code>m</code> columns are labelled <code>P0</code>,
<code>P1</code> through to <code>P(m)</code>.</p>
<?prettify?>

<pre><code class="java">/**
 * Calculates equity curves over a date range given a frame on initial portfolio weight configurations
 * @param range         the date range for historical returns
 * @param portfolios    MxN DataFrame of portfolio weights, M portfolios, N assets
 * @return              the cumulative returns for each portfolio, TxM, portfolios labelled P0, P1 etc...
 */
DataFrame&lt;LocalDate,String&gt; getEquityCurves(Range&lt;LocalDate&gt; range, DataFrame&lt;Integer,String&gt; portfolios) {
    final YahooFinance yahoo = new YahooFinance();
    final Iterable&lt;String&gt; tickers = portfolios.cols().keyArray();
    final DataFrame&lt;LocalDate,String&gt; cumReturns = yahoo.getCumReturns(range.start(), range.end(), tickers);
    final Range&lt;String&gt; colKeys = Range.of(0, portfolios.rowCount()).map(i -&gt; &quot;P&quot; + i);
    return DataFrame.ofDoubles(cumReturns.rows().keyArray(), colKeys, v -&gt; {
        double totalReturn = 0d;
        for (int i=0; i&lt;portfolios.colCount(); ++i) {
            final double weight = portfolios.data().getDouble(v.colOrdinal(), i);
            final double assetReturn = cumReturns.data().getDouble(v.rowOrdinal(), i);
            totalReturn += (weight * assetReturn);
        }
        return totalReturn;
    });
}
</code></pre>

<h4 id="proposed-portfolio">Proposed Portfolio</h4>
<p>Given the <strong>proposed portfolio weights</strong> presented earlier, we can use the past 1 year of returns for the assets in question
to assess what the risk and return of this portfolio would have been had we invested a year ago. The code below performs
this analysis and suggests that the portfolio returned a very respectable <code>14.9%</code> for <code>7.0%</code> risk, which is pretty phenomenal
(a 2 <a href="#sharpe-ratio">Sharpe</a> portfolio over the past year). The code to generate these results is as follows:</p>
<?prettify?>

<pre><code class="java">//Defines investment horizon &amp; universe
LocalDate end = LocalDate.now();
LocalDate start = end.minusYears(1);
//Define investment universe and weights
Array&lt;String&gt; tickers = Array.of(&quot;VTI&quot;, &quot;VEA&quot;, &quot;VWO&quot;, &quot;VTEB&quot;, &quot;VIG&quot;, &quot;XLE&quot;);
//Define DataFrame of position weights suggested by Wealthfront
DataFrame&lt;String,String&gt; portfolio = DataFrame.of(tickers, String.class, columns -&gt; {
    columns.add(&quot;Weights&quot;, Array.of(0.35d, 0.21d, 0.16d, 0.15d, 0.08d, 0.05d));
});
//Grab daily returns and cumulative returns from Yahoo Finance
YahooFinance yahoo = new YahooFinance();
DataFrame&lt;LocalDate,String&gt; dayReturns = yahoo.getDailyReturns(start, end, tickers);
DataFrame&lt;LocalDate,String&gt; cumReturns = yahoo.getCumReturns(start, end, tickers);
//Compute asset covariance matrix from daily returns and annualize
DataFrame&lt;String,String&gt; sigma = dayReturns.cols().stats().covariance().applyDoubles(x -&gt; x.getDouble() * 252);
DataFrame&lt;LocalDate,String&gt; assetReturns = cumReturns.rows().last().map(DataFrameRow::toDataFrame).get();
//Generate DataFrame of portfolio weights
double portReturn = portfolio.transpose().dot(assetReturns.transpose()).data().getDouble(0, 0);
double portVariance = portfolio.transpose().dot(sigma).dot(portfolio).data().getDouble(0, 0);
IO.println(String.format(&quot;Portfolio Return: %s&quot;, portReturn));
IO.println(String.format(&quot;Portfolio Risk: %s&quot;, Math.sqrt(portVariance)));
</code></pre>

<p>Now that we know how the currently proposed portfolio performed over the past year, let us generate 100,000 random portfolios
in these 6 assets to get a sense of the overall risk / return profile of this universe, and see how the proposed portfolio
compares. The plot below suggests that the proposed portfolio (green dot) is indeed pretty efficient, and may also suggest
that this particular Robo-Advisor's future expectations are not that different from the past year.</p>
<p>One may wonder why the <strong>proposed portfolio</strong> is not exactly on the <strong>Efficient Frontier</strong>, and there are several explanations
for this. The first is that the Robo-Advisor proposed weights are for a <strong>forward looking portfolio</strong>, and our example is using
past 1 year returns to test its efficiency. Secondly, there are an infinite number of ways of estimating an <strong>ex-ante</strong> covariance
matrix, which may involve <strong>exponentially smoothing</strong> returns (perhaps using different <strong>half-lives</strong> to estimate diagonal versus
off-diagonal terms), and perhaps applying shrinkage to off-diagonal terms to improve stability. In our example, we have the
<strong>benefit of hindsight</strong> and simply compute an <strong>ex-post</strong> covariance matrix, doing nothing fancy at all. Finally, the Robo-Advisor
may impose risk constraints (such as capping any one position to be no more than 35% of the portfolio perhaps), which may
penalize the strategy versus a less constrained instance, but which may be a very sensible compromise.</p>
<p align="center">
    <img class="chart" src="../../images/mpt/mpt_5.png"/>
</p>

<p>The code to generate this plot is as follows:</p>
<?prettify?>

<pre><code class="java">//Define portfolio count, investment horizon and universe
int count = 100000;
LocalDate end = LocalDate.now();
LocalDate start = end.minusYears(1);
Array&lt;String&gt; tickers = Array.of(&quot;VTI&quot;, &quot;VEA&quot;, &quot;VWO&quot;, &quot;VTEB&quot;, &quot;VIG&quot;, &quot;XLE&quot;);

//Grab daily returns and cumulative returns from Yahoo Finance
YahooFinance yahoo = new YahooFinance();
DataFrame&lt;LocalDate,String&gt; dayReturns = yahoo.getDailyReturns(start, end, tickers);
DataFrame&lt;LocalDate,String&gt; cumReturns = yahoo.getCumReturns(start, end, tickers);

//Compute asset covariance matrix from daily returns and annualize
DataFrame&lt;String,String&gt; sigma = dayReturns.cols().stats().covariance().applyDoubles(v -&gt; v.getDouble() * 252);
DataFrame&lt;LocalDate,String&gt; assetReturns = cumReturns.rows().last().map(DataFrameRow::toDataFrame).get();

//Generate random portfolios and compute risk &amp; return for each
DataFrame&lt;Integer,String&gt; portfolios = randomPortfolios(count, tickers);
DataFrame&lt;Integer,String&gt;  results = DataFrame.ofDoubles(Range.of(0, count), Array.of(&quot;Risk&quot;, &quot;Random&quot;));
portfolios.rows().forEach(row -&gt; {
    DataFrame&lt;Integer,String&gt; weights = row.toDataFrame();
    double portReturn = weights.dot(assetReturns.transpose()).data().getDouble(0, 0);
    double portVariance = weights.dot(sigma).dot(weights.transpose()).data().getDouble(0, 0);
    results.data().setDouble(row.key(), &quot;Random&quot;, portReturn * 100d);
    results.data().setDouble(row.key(), &quot;Risk&quot;, Math.sqrt(portVariance) * 100d);
});

//Create DataFrame with risk / return of proposed Wealthfront portfolio
DataFrame&lt;Integer,String&gt; proposed = DataFrame.of(Range.of(0, 1), String.class, cols -&gt; {
    cols.add(&quot;Risk&quot;, Array.of(0.068950 * 100d));
    cols.add(&quot;Chosen&quot;, Array.of(0.1587613 * 100d));
});

//Plot the results using a scatter plot
Chart.create().withScatterPlot(results, false, &quot;Risk&quot;, chart -&gt; {
    chart.title().withText(&quot;Risk / Return Profile For Wealthfront Portfolio&quot;);
    chart.subtitle().withText(count + &quot; Portfolio Combinations Simulated&quot;);
    chart.plot().&lt;String&gt;data().add(proposed, &quot;Risk&quot;);
    chart.plot().render(1).withDots();
    chart.plot().axes().domain().label().withText(&quot;Portfolio Risk&quot;);
    chart.plot().axes().domain().format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.plot().axes().range(0).label().withText(&quot;Portfolio Return&quot;);
    chart.plot().axes().range(0).format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.legend().on().right();
    chart.show();
});
</code></pre>

<h4 id="efficiency">Efficiency</h4>
<p>The previous section established that the <strong>proposed portfolio</strong> was reasonably efficient in the context of the past 1 year of
returns (how efficient it will be over the next year is of course impossible to know, but all else being equal, it seems a decent
configuration). In this section, we further consider its relative efficiency by looking at the equity curve of the <strong>best</strong> and
<strong>worst</strong> portfolios that we find in our 100,000 random candidates (based on their <a href="#sharpe-ratio">Sharpe Ratios</a>). In addition,
we overlay the equity curve of the <strong>S&amp;P500</strong> by using the SPY Exchange Traded Fund as a proxy.</p>
<p>The plot below shows that the <strong>proposed portfolio</strong> actually outperformed what is labelled as the <strong>Best</strong> portfolio in pure
<strong>return space</strong>, but not in <strong>risk-adjusted terms</strong>. That is, it yields a lower return per unit of risk than the <strong>best</strong> portfolio,
and the fact that it outperformed in return space is just a fluke. The <strong>worst</strong> portfolio is a genuine shocker, and in fact
spent much of the past year going nowhere before bouncing back starting in August.</p>
<p align="center">
    <img class="chart" src="../../images/mpt/mpt_6.png"/>
</p>

<p>The code to generate this plot is as follows, and leverages the <code>getEquityCurves()</code> function discussed earlier.</p>
<?prettify?>

<pre><code class="java">int portfolioCount = 1000;
Range&lt;LocalDate&gt; range = Range.of(LocalDate.now().minusYears(1), LocalDate.now());
Array&lt;String&gt; tickers = Array.of(&quot;VTI&quot;, &quot;VEA&quot;, &quot;VWO&quot;, &quot;VTEB&quot;, &quot;VIG&quot;, &quot;XLE&quot;);
Array&lt;Double&gt; proposed = Array.of(0.35d, 0.21d, 0.16d, 0.15d, 0.08d, 0.05d);
DataFrame&lt;Integer,String&gt; portfolios = randomPortfolios(portfolioCount, tickers);
portfolios.rowAt(0).applyDoubles(v -&gt; proposed.getDouble(v.colOrdinal()));
//Compute risk / return / sharpe for random portfolios
DataFrame&lt;Integer,String&gt; riskReturn = calcRiskReturn(range, portfolios).rows().sort(false, &quot;Sharpe&quot;);
//Capture portfolio keys for chosen, best and worst portfolio based on sharpe
DataFrame&lt;Integer,String&gt; candidates = portfolios.rows().select(0,
    riskReturn.rows().first().get().key(),
    riskReturn.rows().last().get().key()
);
//Compute equity curves for chosen, best and worst
DataFrame&lt;LocalDate,String&gt; equityCurves = getEquityCurves(range, candidates).cols().mapKeys(col -&gt; {
    switch (col.ordinal()) {
        case 0: return &quot;Chosen&quot;;
        case 1: return &quot;Best&quot;;
        case 2: return &quot;Worst&quot;;
        default: return col.key();
    }
});
//Capture returns of S&amp;P 500
YahooFinance yahoo = new YahooFinance();
DataFrame&lt;LocalDate,String&gt; spy = yahoo.getCumReturns(range.start(), range.end(), &quot;SPY&quot;);

//Plot the equity curves
Chart.create().withLinePlot(equityCurves.applyDoubles(v -&gt; v.getDouble() * 100d), chart -&gt; {
    chart.title().withText(&quot;Best/Worst/Chosen Equity Curves (Past 1 Year Returns) + SPY&quot;);
    chart.subtitle().withText(&quot;Robo-Advisor Universe: VTI, VEA, VWO, VTEB, VIG, XLE&quot;);
    chart.plot().&lt;String&gt;data().add(spy.times(100d));
    chart.plot().axes().domain().label().withText(&quot;Date&quot;);
    chart.plot().axes().range(0).label().withText(&quot;Return&quot;);
    chart.plot().axes().range(0).format().withPattern(&quot;0.00'%';-0.00'%'&quot;);
    chart.plot().style(&quot;Chosen&quot;).withColor(Color.BLACK).withLineWidth(1.5f);
    chart.plot().style(&quot;Best&quot;).withColor(Color.GREEN.darker().darker()).withLineWidth(1.5f);
    chart.plot().style(&quot;Worst&quot;).withColor(Color.RED).withLineWidth(1.5f);
    chart.plot().style(&quot;SPY&quot;).withColor(Color.BLUE);
    chart.legend().on();
    chart.show();
});
</code></pre>

<p>The implementation of <code>calcRiskReturn()</code> in this example is as follows:</p>
<?prettify?>

<pre><code class="java">/**
 * Returns a DataFrame containing risk, return and sharpe ratio for portfolios over the date range
 * @param range         the date range for historical returns
 * @param portfolios    the DataFrame of portfolio weights, one row per portfolio configuration
 * @return              the DataFrame with risk, return and sharpe
 */
DataFrame&lt;Integer,String&gt; calcRiskReturn(Range&lt;LocalDate&gt; range, DataFrame&lt;Integer,String&gt; portfolios) {
    YahooFinance yahoo = new YahooFinance();
    Array&lt;String&gt; tickers = portfolios.cols().keyArray();
    DataFrame&lt;LocalDate,String&gt; dayReturns = yahoo.getDailyReturns(range.start(), range.end(), tickers);
    DataFrame&lt;LocalDate,String&gt; cumReturns = yahoo.getCumReturns(range.start(), range.end(), tickers);
    //Compute asset covariance matrix from daily returns and annualize
    DataFrame&lt;String,String&gt; sigma = dayReturns.cols().stats().covariance().applyDoubles(x -&gt; x.getDouble() * 252);
    DataFrame&lt;LocalDate,String&gt; assetReturns = cumReturns.rows().last().map(DataFrameRow::toDataFrame).get();
    //Prepare 3 column DataFrame to capture results
    DataFrame&lt;Integer,String&gt;  riskReturn = DataFrame.ofDoubles(
        portfolios.rows().keyArray(),
        Array.of(&quot;Risk&quot;, &quot;Return&quot;, &quot;Sharpe&quot;)
    );
    portfolios.rows().forEach(row -&gt; {
        DataFrame&lt;Integer,String&gt; weights = row.toDataFrame();
        double portReturn = weights.dot(assetReturns.transpose()).data().getDouble(0, 0);
        double portVariance = weights.dot(sigma).dot(weights.transpose()).data().getDouble(0, 0);
        riskReturn.data().setDouble(row.key(), &quot;Return&quot;, portReturn * 100d);
        riskReturn.data().setDouble(row.key(), &quot;Risk&quot;, Math.sqrt(portVariance) * 100d);
        riskReturn.data().setDouble(row.key(), &quot;Sharpe&quot;, portReturn / Math.sqrt(portVariance));
    });
    return riskReturn;
}
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright (C) 2014-2017 Xavier Witdouck</p>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script src="http://www.zavtech.com/morpheus/docs/javascript/analytics.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
