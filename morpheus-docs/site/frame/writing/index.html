<!--
  ~ Copyright (C) 2014-2018 D3X Systems - All Rights Reserved
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="author" content="Xavier Witdouck">

        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Writing - Morpheus</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../.././css/morpheus.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Morpheus</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Overview</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Array <b class="caret"></b></a>
                        <ul class="dropdown-menu">

<li >
    <a href="../../array/overview/">Overview</a>
</li>

<li >
    <a href="../../array/performance/">Performance</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">DataFrame <b class="caret"></b></a>
                        <ul class="dropdown-menu">

<li >
    <a href="../construction/">Construction</a>
</li>

<li >
    <a href="../access/">Accessing</a>
</li>

<li >
    <a href="../reshaping/">Reshaping</a>
</li>

<li >
    <a href="../filtering/">Filtering</a>
</li>

<li >
    <a href="../sorting/">Sorting</a>
</li>

<li >
    <a href="../grouping/">Grouping</a>
</li>

<li >
    <a href="../finding/">Finding</a>
</li>

<li class="active">
    <a href="./">Writing</a>
</li>

<li >
    <a href="../performance/">Performance</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Analysis <b class="caret"></b></a>
                        <ul class="dropdown-menu">

<li >
    <a href="../../analysis/statistics/">Descriptive Statistics</a>
</li>

  <li class="dropdown-submenu">
    <a href="#">Linear Regression</a>
    <ul class="dropdown-menu">

<li >
    <a href="../../regression/ols/">Ordinary Least Squares</a>
</li>

<li >
    <a href="../../regression/wls/">Weighted Least Squares</a>
</li>

<li >
    <a href="../../regression/gls/">Generalized Least Squares</a>
</li>
    </ul>
  </li>

<li >
    <a href="../../analysis/pca/">Principal Component Analysis</a>
</li>

<li >
    <a href="../../analysis/linearalgebra/">Linear Algebra</a>
</li>

<li >
    <a href="../../analysis/timeseries/">Time Series Analysis</a>
</li>

  <li class="dropdown-submenu">
    <a href="#">Examples</a>
    <ul class="dropdown-menu">

<li >
    <a href="../../examples/mpt/">Modern Portfolio Theory</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Visualization <b class="caret"></b></a>
                        <ul class="dropdown-menu">

  <li class="dropdown-submenu">
    <a href="#">Charts</a>
    <ul class="dropdown-menu">

<li >
    <a href="../../viz/charts/overview/">Overview</a>
</li>

<li >
    <a href="../../viz/charts/embed/">Embedding (HTML)</a>
</li>

<li >
    <a href="../../viz/charts/gallery1/">Gallery (Google)</a>
</li>

<li >
    <a href="../../viz/charts/gallery2/">Gallery (JFree)</a>
</li>
    </ul>
  </li>

<li >
    <a href="../../viz/tables/overview/">Tables</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data Sources <b class="caret"></b></a>
                        <ul class="dropdown-menu">

<li >
    <a href="../../providers/quandl/">Quandl</a>
</li>

<li >
    <a href="../../providers/fred/">Federal Reserve</a>
</li>

<li >
    <a href="../../providers/google/">Google Finance</a>
</li>

<li >
    <a href="../../providers/yahoo/">Yahoo Finance</a>
</li>

<li >
    <a href="../../providers/world-bank/">World Bank</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../finding/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../performance/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/zavtech/morpheus-core">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#writing-data">Writing Data</a></li>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#csv">CSV</a></li>
            <li><a href="#json">JSON</a></li>
            <li><a href="#sql">SQL</a></li>
            <li><a href="#custom-sink">Custom Sink</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h3 id="writing-data">Writing Data</h3>
<h4 id="introduction">Introduction</h4>
<p>The Morpheus library provides a simple yet powerful API to write a <code>DataFrame</code> to an output device for persistent
storage, which can then be later read back into memory. Currently there is built in support for writing a frame out
to CSV and JSON formats, as well as to SQL databases (current support is limited to MYSQL, Microsoft SQL Server, HSQLDB
and Sqlite). It is easy to write a custom sink which integrates naturally with the Morpheus API, and an example of this
is provided in a later section below.</p>
<p>The <code>DataFrameWrite</code> interface which can be accessed by calling <code>write()</code> on a frame instance, provides format specific
output methods, as well as a generalized method for user defined sinks. The following sections cover CSV, JSON and database
output, as well as a custom sink that records a frame as a Java serialized object. For the examples in this section,
consider the following 10x7 containing various data types for the columns to illustrate how these can be mapped
to the output.</p>
<?prettify?>

<pre><code class="java">final LocalDate start = LocalDate.of(2014, 1, 1);
final Range&lt;LocalDate&gt; rowKeys = Range.of(start, start.plusDays(10));
DataFrame&lt;LocalDate,String&gt; frame = DataFrame.of(rowKeys, String.class, columns -&gt; {
    columns.add(&quot;Column-0&quot;, Boolean.class, v -&gt; Math.random() &gt; 0.5d);
    columns.add(&quot;Column-1&quot;, Double.class, v -&gt; Math.random() * 10d);
    columns.add(&quot;Column-2&quot;, LocalTime.class, v -&gt; LocalTime.now().plusMinutes(v.rowOrdinal()));
    columns.add(&quot;Column-3&quot;, Month.class, v -&gt; Month.values()[v.rowOrdinal()+1]);
    columns.add(&quot;Column-4&quot;, Integer.class, v -&gt; (int)(Math.random() * 10));
    columns.add(&quot;Column-5&quot;, String.class, v -&gt; String.format(&quot;(%s,%s)&quot;, v.rowOrdinal(), v.colOrdinal()));
    columns.add(&quot;Column-6&quot;, LocalDateTime.class, v -&gt; LocalDateTime.now().plusMinutes(v.rowOrdinal()));
});
</code></pre>

<div class="frame"><pre class="frame">
   Index     |  Column-0  |   Column-1   |    Column-2    |  Column-3   |  Column-4  |  Column-5  |         Column-6          |
-------------------------------------------------------------------------------------------------------------------------------
 2014-01-01  |     false  |  1.25672365  |   21:00:13.73  |   FEBRUARY  |         4  |     (0,5)  |  2014-08-02T21:00:13.759  |
 2014-01-02  |      true  |  4.41265583  |  21:01:13.732  |      MARCH  |         3  |     (1,5)  |  2014-08-02T21:01:13.759  |
 2014-01-03  |     false  |  7.82861945  |  21:02:13.732  |      APRIL  |         4  |     (2,5)  |  2014-08-02T21:02:13.759  |
 2014-01-04  |      true  |  1.32584627  |  21:03:13.732  |        MAY  |         4  |     (3,5)  |  2014-08-02T21:03:13.759  |
 2014-01-05  |     false  |  0.55894277  |  21:04:13.732  |       JUNE  |         2  |     (4,5)  |  2014-08-02T21:04:13.759  |
 2014-01-06  |     false  |  3.52911319  |  21:05:13.732  |       JULY  |         2  |     (5,5)  |  2014-08-02T21:05:13.759  |
 2014-01-07  |      true  |  1.12132289  |  21:06:13.732  |     AUGUST  |         6  |     (6,5)  |  2014-08-02T21:06:13.759  |
 2014-01-08  |     false  |  6.78505742  |  21:07:13.732  |  SEPTEMBER  |         8  |     (7,5)  |  2014-08-02T21:07:13.759  |
 2014-01-09  |     false  |  2.79950377  |  21:08:13.732  |    OCTOBER  |         4  |     (8,5)  |  2014-08-02T21:08:13.759  |
 2014-01-10  |     false  |  6.16985695  |  21:09:13.732  |   NOVEMBER  |         4  |     (9,5)  |  2014-08-02T21:09:13.759  |
</pre></div>

<h4 id="csv">CSV</h4>
<p>Storing tabular data as CSV text is common practice, so it is only natural that a <code>DataFrame</code> can be written out in
this format. The Morpheus library ships with a default CSV output handler called <code>CsvSink</code>, however it is possible to
write a custom CSV sink if necessary. The example below writes the <code>DataFrame</code> presented in the introduction to a CSV
file with various customizations applied via the <code>CsvSinkOptions</code> object. The customizations are as follows:</p>
<pre><code>1. Set the separator, which defulats to a comma.
2. Set whether the row keys are included in output
3. Set whether the column keys are included in output
4. Set the text to print for null values
5. Set the title for the row key column
6. Set a custom Printer to format row keys (otherwise defaults to Object.toString())
7. Set a custim Printer to format column keys (otherwise defaults to Object.toString())
8. Set type specific and column specific Printers
</code></pre>
<?prettify?>

<pre><code class="java">frame.write().csv(options -&gt; {
    options.setFile(&quot;DataFrame-1.csv&quot;);
    options.setSeparator(&quot;,&quot;);
    options.setIncludeRowHeader(true);
    options.setIncludeColumnHeader(true);
    options.setNullText(&quot;null&quot;);
    options.setTitle(&quot;Date&quot;);

    DateTimeFormatter dateFormat = DateTimeFormatter.ofPattern(&quot;dd/MMM/yyyy&quot;);
    options.setRowKeyPrinter(Printer.ofLocalDate(dateFormat));

    options.setFormats(formats -&gt; {
        DateTimeFormatter timeFormat = DateTimeFormatter.ofPattern(&quot;HH:mm&quot;);
        DateTimeFormatter dateTimeFormat = DateTimeFormatter.ofPattern(&quot;dd-MMM-yyyy HH:mm&quot;);
        formats.setDecimalFormat(Double.class, &quot;0.00##;-0.00##&quot;, 1);
        formats.setPrinter(&quot;Column-2&quot;, Printer.ofLocalTime(timeFormat));
        formats.&lt;Month&gt;setPrinter(&quot;Column-3&quot;, Printer.forObject(m -&gt; m.name().toLowerCase()));
        formats.setPrinter(&quot;Column-6&quot;, Printer.ofLocalDateTime(dateTimeFormat));
    });
});
</code></pre>

<p>The resulting file output is shown below. Note how custom column formats are configured above using either a data type,
or with an explicit column name. The <code>CsvSink</code> will attempt to look up a printer for the column name first, and if no
printer is registered, it will fall back onto a printer for the data type associated with the column. In addition,
an explicit printer can be configured for the row keys, and we can control whether the row header and column header
are included in the output, which by default they are.</p>
<div class="frame"><pre class="frame">
Date,Column-0,Column-1,Column-2,Column-3,Column-4,Column-5,Column-6
2014-01-01,false,1.2567,21:00,february,4,(0,5),02-Aug-2014 21:00
2014-01-02,true,4.4127,21:01,march,3,(1,5),02-Aug-2014 21:01
2014-01-03,false,7.8286,21:02,april,4,(2,5),02-Aug-2014 21:02
2014-01-04,true,1.3258,21:03,may,4,(3,5),02-Aug-2014 21:03
2014-01-05,false,0.5589,21:04,june,2,(4,5),02-Aug-2014 21:04
2014-01-06,false,3.5291,21:05,july,2,(5,5),02-Aug-2014 21:05
2014-01-07,true,1.1213,21:06,august,6,(6,5),02-Aug-2014 21:06
2014-01-08,false,6.7851,21:07,september,8,(7,5),02-Aug-2014 21:07
2014-01-09,false,2.7995,21:08,october,4,(8,5),02-Aug-2014 21:08
2014-01-10,false,6.1699,21:09,november,4,(9,5),02-Aug-2014 21:09
</pre></div>

<p>The <code>CsvSinkOptions</code> allows the output resource to be specified as either a <code>File</code>, <code>URL</code> or an <code>OutputStream</code>.
The latter is the most flexible in that a user has full control of how the output is written. For example, consider the
same frame as above, but in this case we wish to write to a URL endpoint via http POST, expressing the frame as GZIP
compressed CSV. In order to do this, we write the frame to a <code>ByteArrayOutputStream</code>, and then perform the http POST with
the resulting bytes.</p>
<?prettify?>

<pre><code class="java">ByteArrayOutputStream baos = new ByteArrayOutputStream();
frame.write().csv(options -&gt; {
    try {
        options.setOutputStream(new GZIPOutputStream(baos));
        options.setSeparator(&quot;,&quot;);
        options.setIncludeRowHeader(true);
        options.setIncludeColumnHeader(true);
        options.setNullText(&quot;null&quot;);
        options.setTitle(&quot;Date&quot;);
        options.setRowKeyPrinter(LocalDate::toString);
        options.setFormats(formats -&gt; {
            DateTimeFormatter timeFormat = DateTimeFormatter.ofPattern(&quot;HH:mm&quot;);
            DateTimeFormatter dateTimeFormat = DateTimeFormatter.ofPattern(&quot;dd-MMM-yyyy HH:mm&quot;);
            formats.setDecimalFormat(Double.class, &quot;0.00##;-0.00##&quot;, 1);
            formats.&lt;Month&gt;setPrinter(&quot;Column-2&quot;, v -&gt; v.name().toLowerCase());
            formats.&lt;LocalTime&gt;setPrinter(&quot;Column-1&quot;, timeFormat::format);
            formats.&lt;LocalDateTime&gt;setPrinter(&quot;Column-5&quot;, dateTimeFormat::format);
        });
    } catch (IOException ex) {
        throw new RuntimeException(ex.getMessage(), ex);
    }
});

final byte[] bytes = baos.toByteArray();
HttpClient.getDefault().doPost(post -&gt; {
    post.setRetryCount(5);
    post.setReadTimeout(5000);
    post.setConnectTimeout(1000);
    post.setUrl(&quot;http://www.domain.con/test&quot;);
    post.setContent(bytes);
    post.setContentType(&quot;application/x-gzip&quot;);
    post.setContentLength(bytes.length);
    post.setResponseHandler((status, stream) -&gt; {
        if (status.getCode() == 200) {
            return Optional.empty();
        } else {
            throw new RuntimeException(&quot;Failed with response: &quot; + status);
        }
    });
});
</code></pre>

<h4 id="json">JSON</h4>
<p>Writing a <code>DataFrame</code> out in JSON format works similar to the CSV example above, however the output options differ
slightly. If we use the same 10x7 frame introduced earlier, we can write out JSON with custom formatting as shown below. </p>
<p>Meta-data in the payload is included to allow a subsequent reader to re-constitute the frame with the appropriate data
types. For example, <code>Integer</code> and <code>Long</code> types are not distinguishable in standard JSON output, but the <code>dataType</code> field
which is written as a JSON property for each column object definition, provides the required information. Other types,
like <code>LocalTime</code>, and <code>LocalDateTime</code> in this example are formatted into a string which can be controlled via the options
<code>Formats</code> entity, much the same way as CSV formatting works. The data type property for objects like these is mapped
to the simple name of the class.</p>
<?prettify?>

<pre><code class="java">frame.write().json(options -&gt; {
    options.setFile(&quot;DataFrame-1.json&quot;);
    options.setEncoding(&quot;UTF-8&quot;);
    options.setFormats(formats -&gt; {
        DateTimeFormatter timeFormat = DateTimeFormatter.ofPattern(&quot;HH:mm&quot;);
        DateTimeFormatter dateTimeFormat = DateTimeFormatter.ofPattern(&quot;dd-MMM-yyyy HH:mm&quot;);
        formats.setPrinter(&quot;Column-2&quot;, Printer.ofLocalTime(timeFormat));
        formats.&lt;Month&gt;setPrinter(&quot;Column-3&quot;, Printer.forObject(m -&gt; m.name().toLowerCase()));
        formats.setPrinter(&quot;Column-6&quot;, Printer.ofLocalDateTime(dateTimeFormat));
    });
});
</code></pre>

<p>The resulting JSON output is shown below. It should be noted that the <code>JsonSink</code> implementation that ships with Morpheus
uses a stream based JsonWriter, making it very memory efficient even for extremely large frames. The same applies in reverse
with the <code>JsonSource</code> implementation. Finally, the JSON payload includes the row and column count for the frame which is
important to enable the <code>JsonSource</code> to pre-allocate the arrays when reading, which again, improves performance for very
large frames.</p>
<pre><code class="json">{
  &quot;DataFrame&quot;: {
    &quot;rowCount&quot;: 10,
    &quot;colCount&quot;: 7,
    &quot;rowKeys&quot;: {
      &quot;type&quot;: &quot;LocalDate&quot;,
      &quot;values&quot;: [
        &quot;2014-01-01&quot;,
        &quot;2014-01-02&quot;,
        &quot;2014-01-03&quot;,
        &quot;2014-01-04&quot;,
        &quot;2014-01-05&quot;,
        &quot;2014-01-06&quot;,
        &quot;2014-01-07&quot;,
        &quot;2014-01-08&quot;,
        &quot;2014-01-09&quot;,
        &quot;2014-01-10&quot;
      ]
    },
    &quot;columns&quot;: [
      {
        &quot;key&quot;: &quot;Column-0&quot;,
        &quot;keyType&quot;: &quot;String&quot;,
        &quot;dataType&quot;: &quot;Boolean&quot;,
        &quot;defaultValue&quot;: false,
        &quot;values&quot;: [
          true,
          true,
          true,
          true,
          false,
          false,
          true,
          false,
          true,
          false
        ]
      },
      {
        &quot;key&quot;: &quot;Column-1&quot;,
        &quot;keyType&quot;: &quot;String&quot;,
        &quot;dataType&quot;: &quot;Double&quot;,
        &quot;defaultValue&quot;: null,
        &quot;values&quot;: [
          3.4243295493435575,
          1.1438780283716343,
          4.316506413470317,
          7.454588915346636,
          6.950360875904566,
          9.491531171790896,
          5.204554855321635,
          5.754177059739899,
          0.8195736745281579,
          6.988186292016216
        ]
      },
      {
        &quot;key&quot;: &quot;Column-2&quot;,
        &quot;keyType&quot;: &quot;String&quot;,
        &quot;dataType&quot;: &quot;LocalTime&quot;,
        &quot;defaultValue&quot;: null,
        &quot;values&quot;: [
          &quot;21:24&quot;,
          &quot;21:25&quot;,
          &quot;21:26&quot;,
          &quot;21:27&quot;,
          &quot;21:28&quot;,
          &quot;21:29&quot;,
          &quot;21:30&quot;,
          &quot;21:31&quot;,
          &quot;21:32&quot;,
          &quot;21:33&quot;
        ]
      },
      {
        &quot;key&quot;: &quot;Column-3&quot;,
        &quot;keyType&quot;: &quot;String&quot;,
        &quot;dataType&quot;: &quot;Month&quot;,
        &quot;defaultValue&quot;: null,
        &quot;values&quot;: [
          &quot;february&quot;,
          &quot;march&quot;,
          &quot;april&quot;,
          &quot;may&quot;,
          &quot;june&quot;,
          &quot;july&quot;,
          &quot;august&quot;,
          &quot;september&quot;,
          &quot;october&quot;,
          &quot;november&quot;
        ]
      },
      {
        &quot;key&quot;: &quot;Column-4&quot;,
        &quot;keyType&quot;: &quot;String&quot;,
        &quot;dataType&quot;: &quot;Integer&quot;,
        &quot;defaultValue&quot;: 0,
        &quot;values&quot;: [
          9,
          9,
          5,
          7,
          0,
          2,
          8,
          5,
          5,
          0
        ]
      },
      {
        &quot;key&quot;: &quot;Column-5&quot;,
        &quot;keyType&quot;: &quot;String&quot;,
        &quot;dataType&quot;: &quot;String&quot;,
        &quot;defaultValue&quot;: null,
        &quot;values&quot;: [
          &quot;(0,5)&quot;,
          &quot;(1,5)&quot;,
          &quot;(2,5)&quot;,
          &quot;(3,5)&quot;,
          &quot;(4,5)&quot;,
          &quot;(5,5)&quot;,
          &quot;(6,5)&quot;,
          &quot;(7,5)&quot;,
          &quot;(8,5)&quot;,
          &quot;(9,5)&quot;
        ]
      },
      {
        &quot;key&quot;: &quot;Column-6&quot;,
        &quot;keyType&quot;: &quot;String&quot;,
        &quot;dataType&quot;: &quot;LocalDateTime&quot;,
        &quot;defaultValue&quot;: null,
        &quot;values&quot;: [
          &quot;02-Aug-2014 21:24&quot;,
          &quot;02-Aug-2014 21:25&quot;,
          &quot;02-Aug-2014 21:26&quot;,
          &quot;02-Aug-2014 21:27&quot;,
          &quot;02-Aug-2014 21:28&quot;,
          &quot;02-Aug-2014 21:29&quot;,
          &quot;02-Aug-2014 21:30&quot;,
          &quot;02-Aug-2014 21:31&quot;,
          &quot;02-Aug-2014 21:32&quot;,
          &quot;02-Aug-2014 21:33&quot;
        ]
      }
    ]
  }
}
</code></pre>

<h4 id="sql">SQL</h4>
<p>The third built-in sink that ships with the Morpheus library enables frames to be written out to a SQL database, with
support for <a href="https://www.mysql.com/">MYSQL</a>, <a href="http://hsqldb.org/">HSQLDB</a>, <a href="https://www.sqlite.org/">SQLite</a>,
<a href="http://www.h2database.com/html/main.html">H2 Database</a> and <a href="https://www.microsoft.com/en-us/sql-server">Microsoft SQL Server</a>.</p>
<p>The <code>DbSink</code> can be used to write a <code>DataFrame</code> to an existing table, or otherwise have a table automatically created if
none exists. Obviously the latter scenario requires that the authenticated user has adequate permissions to create database
objects, otherwise an exception will be raised. The <code>DbSinkOptions</code> class allows some control for how the frame columns are
mapped and stored in the database, both in terms of column names and column types.</p>
<p>Consider the code example below where we write the same 10x7 <code>DataFrame</code> presented in the introduction to an HSQLDB instance.
In this scenario, we pass the JDBC URL and credentials to the <code>DbSinkOptions</code>, however the connection can be passed via a
<code>java.sql.DataSource</code> or a <code>java.sql.Connection</code> object. For large frames, it is important to leverage SQL batch inserts, and
the batch size can be controlled via <code>DbSinkOptions</code>. Finally, the code below also demonstrates how to map the <code>DataFrame</code>
column keys to database column names, and also how to map types. While built in support exists for <code>LocalDate</code> and <code>Enum</code>
types, the example explicitly sets a custom mapping for illustration purposes.</p>
<?prettify?>

<pre><code class="java">Class.forName(&quot;org.hsqldb.jdbcDriver&quot;);
frame.write().db(options -&gt; {
    options.setBatchSize(1000);
    options.setTableName(&quot;TestTable&quot;);
    options.setConnection(&quot;jdbc:hsqldb:/Users/witdxav/morpheus/tests/DataFrame_3.db&quot;, &quot;sa&quot;, null);
    options.setRowKeyMapping(&quot;Date&quot;, Date.class, Function1.toValue(Date::valueOf));
    options.setColumnMappings(mappings -&gt; {
        mappings.add(Month.class, String.class, Function1.toValue(v -&gt; {
            return v.&lt;Month&gt;getValue().name().toLowerCase();
        }));
        mappings.add(LocalDate.class, java.sql.Date.class, Function1.toValue(v -&gt; {
            return Date.valueOf(v.&lt;LocalDate&gt;getValue());
        }));
    });
    options.setColumnNames(colKey -&gt; {
        switch (colKey) {
            case &quot;Column-1&quot;:    return &quot;Column-A&quot;;
            case &quot;Column-2&quot;:    return &quot;Column-B&quot;;
            case &quot;Column-3&quot;:    return &quot;Column-C&quot;;
            default:            return colKey;
        }
    });
});
</code></pre>

<h4 id="custom-sink">Custom Sink</h4>
<p>Writing a custom sink is fairly trivial, and involves implementing two classes, namely an implementation of the <code>DataFrameSink</code>
interface, and a correponding options class that describes how the frame should be output. In this section, we show how one could
write a custom sink to record a <code>DataFrame</code> as a serialized object using standard java object serialization. The code below shows
an implementation of a <code>DataFrameSink</code> which has been called <code>CustomSink</code> for lack of a better name.</p>
<?prettify?>

<pre><code class="java">public class CustomSink&lt;R,C&gt; implements DataFrameSink&lt;R,C,CustomSinkOptions&gt; {
    @Override
    public void write(DataFrame&lt;R,C&gt; frame, Consumer&lt;CustomSinkOptions&gt; configurator) {
        final CustomSinkOptions options = Initialiser.apply(new CustomSinkOptions(), configurator);
        ObjectOutputStream os = null;
        try {
            if (options.isCompressed()) {
                os = new ObjectOutputStream(new GZIPOutputStream(options.getOutput()));
                os.writeObject(frame);
            } else {
                os = new ObjectOutputStream(options.getOutput());
                os.writeObject(frame);
            }
        } catch (Exception ex) {
            throw new DataFrameException(&quot;Failed to write DataFrame to serialized output&quot;, ex);
        } finally {
            IO.close(os);
        }
    }
}
</code></pre>

<p>This class implements a single <code>write()</code> method which takes the frame to record, and a <code>Consumer</code> that is used to configure
the output options. The options class is usually sink specific, and in this example we have written a class called <code>CustomSinkOptions</code>
which carries the <code>OutputStream</code> to write to, and a flag to indicate whether output should be compressed. The options class
looks as follows.`</p>
<?prettify?>

<pre><code class="java">public class CustomSinkOptions {

    private OutputStream output;
    private boolean compressed;

    /**
     * Returns the output stream to write to
     * @return      the output stream to write to
     */
    public OutputStream getOutput() {
        return output;
    }

    /**
     * Returns true if compression is enabled
     * @return  true if compression is enabled
     */
    public boolean isCompressed() {
        return compressed;
    }

    /**
     * Sets the output for these options
     * @param output    the output stream to write to
     */
    public void setOutput(OutputStream output) {
        this.output = output;
    }

    /**
     * Sets the file output for these options
     * @param file  the output file
     */
    public void setFile(File file) {
        this.output = Try.call(() -&gt; new BufferedOutputStream(new FileOutputStream(file)));
    }

    /**
     * Sets whether the output should be wrapped in a GZIP stream
     * @param compressed    true to wrap output in GZIP compression
     */
    public void setCompressed(boolean compressed) {
        this.compressed = compressed;
    }
}
</code></pre>

<p>To use this sink to write a frame, consider the following code using the same frame from the introduction. In this
case we create an instance of the sink to write to, and implement a <code>Consumer</code> to configure the sink specific options
as shown. which includes setting the output file and enabling GZIP compression.</p>
<?prettify?>

<pre><code class="java">frame.write().to(new CustomSink&lt;&gt;(), options -&gt; {
    options.setFile(new File(&quot;/Users/witdxav/test/DataFrame-1.gzip&quot;));
    options.setCompressed(true);
});
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright (C) 2014-2017 Xavier Witdouck</p>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script src="http://www.zavtech.com/morpheus/docs/javascript/analytics.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
